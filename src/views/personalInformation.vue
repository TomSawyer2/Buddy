<template>
  <div
    style="
      display: flex;
      flex-direction: row;
      width: 100%;
      justify-content: center;
      align-items: center;
    "
  >
    <v-form
      ref="form"
      v-model="valid"
      lazy-validation
      style="width: 50%"
      class="mt-10"
    >
      <div style="display: flex; flex-direction: row; align-items: center">
        <v-avatar size="100"><img v-bind:src="formData.avatar" /></v-avatar>
        <v-file-input
          accept="image/png, image/jpeg, image/bmp, image/jfif"
          placeholder="选择图片"
          prepend-icon="mdi-camera"
          label="更换头像"
          class="ml-5"
          style="width: 20%"
          v-model="updateFile.file"
          @change="changeAvatar()"
        ></v-file-input>
      </div>

      <div style="display: flex; flex-direction: row; align-items: center">
        <v-file-input
          accept="image/png, image/jpeg, image/bmp, image/jfif"
          placeholder="选择图片"
          prepend-icon="mdi-qrcode"
          label="上传微信二维码"
          class="pt-10"
          style="width: 100%"
          v-model="updateQRCodeFile.file"
          @change="updateQRCode()"
        ></v-file-input>
        <v-btn @click="pushToWeChatPic" small class="mt-3">查看二维码</v-btn>
      </div>

      <v-text-field
        v-model="formData.phoneNumber"
        :rules="rules.phoneNumberRules"
        label="电话"
        required
      ></v-text-field>

      <v-text-field
        v-model="formData.email"
        :rules="rules.emailRules"
        label="E-mail"
        required
      ></v-text-field>

      <v-select
        v-model="formData.sex"
        :items="items.sexItems"
        :rules="[(v) => !!v || '请选择您的性别~']"
        label="性别"
        required
        class="pr-2"
      ></v-select>

      <!-- <div class="d-flex justify-space-between"> -->
        
        <DatePicker @save="save" :date="formData.birthday" class="pl-2"/>
      <!-- </div> -->

      <v-select
        v-model="formData.isGraduated"
        :items="items.isGraduatedItems"
        :rules="[(v) => !!v || '请选择您是否出站~']"
        label="是否出站"
        required
      ></v-select>
      <v-select
        v-model="formData.substation"
        v-if="formData.isGraduated == '是' ? true : false"
        :items="items.substationItems"
        :rules="[(v) => !!v || '请选择您目前所在的分站~']"
        label="所在分站"
        required
      ></v-select>

      <div class="d-flex justify-space-between">
        <v-text-field
          v-model="formData.number"
          :rules="rules.numberRules"
          label="队员编号（若没有则填无）"
          required
          class="pr-2"
        ></v-text-field>
        <v-text-field
          v-model="formData.highSchool"
          :rules="rules.highSchoolRules"
          label="毕业高中"
          required
          class="pl-2"
        ></v-text-field>
      </div>

      <v-select
        v-model="formData.identity"
        :items="items.identityItems"
        :rules="[(v) => !!v || '请选择您目前的身份~']"
        label="身份"
        required
      ></v-select>
      
      <v-combobox
        v-model="formData.field"
        :items="items.fieldItems"
        :search-input.sync="search"
        hide-selected
        hint="最多添加十个标签（若没有对应选项可以直接输入）"
        label="添加更多标签"
        multiple
        persistent-hint
        small-chips
        clearable
        deletable-chips
      >
        <template v-slot:no-data>
          <v-list-item>
            <v-list-item-content>
              <v-list-item-title>
                没有匹配的选项。 按下 <kbd>enter</kbd> 创建新标签。
              </v-list-item-title>
            </v-list-item-content>
          </v-list-item>
        </template>
      </v-combobox>

      <v-text-field
        v-model="formData.teamExperience"
        :rules="rules.teamExperienceRules"
        label="队内经历（现在或曾经所在的项目组/队委会小组等等）"
        required
      ></v-text-field>

      <v-text-field
        v-model="formData.resume"
        :rules="rules.resumeRules"
        label="履历（没有则填无）"
        required
      ></v-text-field>

      <SlidePicker @sendCharacter="sendCharacter" :character="formData.character"/>

      <v-text-field
        v-model="formData.hobby"
        :rules="rules.hobbyRules"
        label="兴趣爱好（请用空格分隔）"
        required
      ></v-text-field>

      <v-text-field v-model="formData.notes" label="备注(选填）"></v-text-field>

      <div class="d-flex justify-center mb-6 mt-6">
        <v-btn
          :disabled="!valid"
          color="success"
          @click="validate"
          style="width: 80%"
        >
          提交
        </v-btn>
      </div>
    </v-form>
  </div>
</template>

<script lang="ts">
import {
  getPersonalInformation,
  updatePersonalInformation,
  postAvatar,
  postQRCode,
  getFields,
  addFields,
} from "../apis";
import {
  setToken,
  getToken,
  removeToken,
  getPhone,
  getAvatarSrc,
  getUserName,
  setAvatarSrc,
} from "../utils/storage";
import { transformAfterGet, transformBeforeUpdate } from "@/utils/transform"
import DatePicker from "@/components/DatePicker/DatePicker.vue";
import SlidePicker from "@/components/SlidePicker/SlidePicker.vue";
export default {
  components: { DatePicker, SlidePicker },
  data: () => ({
    valid: true,
    updateFile: {
      file: [],
    },
    updateQRCodeFile: {
      file: [],
    },
    formData: {
      avatar: "",
      email: "",
      phoneNumber: "",
      birthday: "",
      character: "",
      sex: "",
      hobby: "",
      teamExperience: "",
      number: "",
      highSchool: "",
      field: "",
      resume: "",
      identity: "",
      isGraduated: false,
      substation: "",
      notes: "",
      weChatPic: "",
    },

    rules: {
      emailRules: [
        // (v: string | undefined) => !!v || "请输入电子邮箱地址~",
        (v: string) => /.+@.+\..+/.test(v) || "请输入正确的电子邮箱地址~",
      ],
      phoneNumberRules: [
        // (v: string | undefined) => !!v || "请输入手机号",
        (v: string | undefined) =>
          (v && v.length == 11) || "请输入正确的手机号",
      ],
      // hobbyRules: [(v: string | undefined) => !!v || "请输入您的兴趣爱好~"],
      // teamExperienceRules: [
      //   (v: string | undefined) => !!v || "请输入您的队内经历~",
      // ],
      // numberRules: [(v: string | undefined) => !!v || "请输入您的队员编号~"],
      // highSchoolRules: [
      //   (v: string | undefined) => !!v || "请输入您的毕业高中~",
      // ],
      // fieldRules: [(v: string | undefined) => !!v || "请输入您的技术栈~"],
      // resumeRules: [(v: string | undefined) => !!v || "请输入您的履历~"],
    },
    items: {
      sexItems: ["男", "女"],
      // identityItems: ["在站", "出站", "名誉队员", "导师", "顾问", "临时", "其他"],
      isGraduatedItems: ["是", "否"],
      substationItems: [
        "华中站",
        "杭州站",
        "上海站",
        "西南站",
        "广州站",
        "深圳站",
        "长沙站",
        "北京站",
        "海外站",
      ],
      identityItems: [
        "在站",
        "出站",
        "名誉队员",
        "导师",
        "顾问",
        "临时",
        "其他",
      ],
      fieldItems: [],
    },
    graduated: "",
    identityString: "",
    search: null,
  }),
  mounted() {
    (this as any).formData.phoneNumber = getPhone();
    const { phoneNumber } = (this as any).formData;
    getPersonalInformation({ phoneNumber })
      .then((res: any) => {
        (this as any).formData = transformAfterGet(res.data.data);
      })
      .catch((err) => {
        console.log(err);
        (this as any).$message.error("获取个人信息失败，请重试~");
      });
    (this as any).getAllFields();
  },
  methods: {
    sendCharacter (val) {
      (this as any).formData.character = val;
      console.log(val);
    },
    save (val) {
      (this as any).formData.birthday = val;
      console.log(val);
    },
    async validate() {
      (this as any).$refs.form.validate();
      console.log((this as any).formData);
      (this as any).formData = transformBeforeUpdate((this as any).formData);
      await (this as any).updateFields();
      try {
        await updatePersonalInformation((this as any).formData);
        console.log("更新成功！");
        console.log((this as any).items.fieldItems);
        (this as any).$message.success("更新成功！");
        setAvatarSrc((this as any).formData.avatar);
        (this as any).formData = transformAfterGet((this as any).formData);
      } catch (error) {
        console.log(error);
        (this as any).$message.error("更新失败，请重试~");
      }
      (this as any).getAllFields();
    },
    async changeAvatar() {
      if ((this as any).updateFile.file) {
        console.log("文件大小：" + (this as any).updateFile.file.size);
        if ((this as any).updateFile.file.size / 1024 > 1024) {
          (this as any).$message.error("请上传大小小于1M的图片~");
          console.log("上传文件过大");
          (this as any).updateFile.file = [];
        } else {
          let file = new FormData(); //创建form对象
          file.append("pic", (this as any).updateFile.file); //通过append向form对象添加数据
          console.log(file.get("pic"));
          await postAvatar(file)
            .then((res: any) => {
              console.log(res);
              if (res.data.status == "ok") {
                console.log(res.data.link);
                (this as any).formData.avatar = res.data.link;
                (this as any).$store.state.avatarSrc = res.data.link;
                setAvatarSrc(res.data.link);
              }
            })
            .catch((err: any) => {
              console.log(err);
              (this as any).$message.error("图片上传失败，请重试~");
            });
        }
      }
    },
    async updateQRCode() {
      if ((this as any).updateQRCodeFile.file) {
        console.log("文件大小：" + (this as any).updateQRCodeFile.file.size);
        if ((this as any).updateQRCodeFile.file.size / 1024 > 1024) {
          (this as any).$message.error("请上传大小小于1M的图片~");
          console.log("上传文件过大");
          (this as any).updateQRCodeFile.file = [];
        } else {
          let file = new FormData(); //创建form对象
          file.append("pic", (this as any).updateQRCodeFile.file); //通过append向form对象添加数据
          console.log(file.get("pic"));
          await postQRCode(file)
            .then((res: any) => {
              console.log(res);
              if (res.data.status == "ok") {
                console.log(res.data.link);
                (this as any).formData.weChatPic = res.data.link;
              }
            })
            .catch((err: any) => {
              console.log(err);
              (this as any).$message.error("图片上传失败，请重试~");
            });
        }
      }
    },
    async updateFields() {
      // 取出新添加的标签放入newFields
      var combinedFields = (this as any).items.fieldItems.concat(
        (this as any).formData.field
      );
      console.log("Combined array:" + combinedFields);
      var uniqueFields = Array.from(new Set(combinedFields));
      console.log("Unique array:" + uniqueFields);
      var fieldItems = (this as any).items.fieldItems;
      var _arr1 = uniqueFields.filter((item1) => !fieldItems.includes(item1));
      var _arr2 = fieldItems.filter((item2) => !uniqueFields.includes(item2));
      const _arr = _arr1.concat(_arr2);
      console.log("New fields:" + _arr1);
      var newFields = _arr1;

      if (newFields.length >= 1) {
        newFields.forEach((val: any, idx, array) => {
          console.log(val);
          var field: any = '{"field": ' + '"' + val + '"' + "}";
          addFields(field)
            .then((res: any) => {
              console.log(res);
            })
            .catch((err: any) => {
              console.log(err);
              (this as any).$message.error("添加标签失败，请重试~");
            });
        });
      }
    },
    async getAllFields() {
      getFields()
        .then((res: any) => {
          console.log(res);
          (this as any).items.fieldItems = res.data.data;
        })
        .catch((err) => {
          console.log(err);
        });
    },
    pushToWeChatPic() {
      if ((this as any).formData.weChatPic) {
        window.open((this as any).formData.weChatPic, "_blank");
      } else {
        (this as any).$message.error("请先上传二维码~");
      }
    },
  },
  watch: {
    model(val: any) {
      if (val.length > 10) {
        (this as any).$nextTick(() => (this as any).model.pop());
      }
    },
  },
};
</script>

<style></style>
